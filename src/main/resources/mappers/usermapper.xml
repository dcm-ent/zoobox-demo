<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.dcm.zoobox.user.mapper.UserMapper" >
	<resultMap type="User" id="UserMap">
		<id property="userId" column="user_id"/>
		<result property="password" column="password"/>
		<result property="username" column="username"/>
		<result property="email" column="email"/>
		<result property="nickname" column="nickname"/>
		<result property="birthdate" column="birthdate"/>
		<result property="phone" column="phone"/>
		<result property="regDate" column="reg_date"/>
		<result property="updateDate" column="update_date"/>
		<result property="gender" column="gender"/>
		<result property="bizId" column="biz_id"/>
		<result property="expertId" column="expert_id"/>
		<collection property="userRole" resultMap="UserRoleMap"/>
		<collection property="userInfo" resultMap="UserInfoMap"/>
		<collection property="userSnsInfo" resultMap="UserSnsInfoMap"/>
	</resultMap>
	<resultMap type="UserInfo" id="UserInfoMap"> 
		<result property="userId" column="user_id"/>
		<result property="userInfoId" column="user_info_id"/>
		<result property="exp" column="exp"/>
		<result property="status" column="status"/>
		<result property="count" column="count"/>
		<result property="startDate" column="start_date"/>
	</resultMap>
	<resultMap type="UserRole" id="UserRoleMap"> 
		<result property="userId" column="user_id"/>
		<result property="authority" column="authority"/>
	</resultMap>
	<resultMap type="UserSnsInfo" id="UserSnsInfoMap"> 
		<result property="userSnsInfoId" column="sns_id"/>
		<result property="userId" column="user_id"/>
		<result property="snsEmail" column="email"/>
		<result property="type" column="type"/>
	</resultMap>
	
	<insert id="createUser" parameterType="User">
		insert into user(email, password, birthdate, username, nickname, phone, gender)
		values (#{email},#{password},#{birthdate},#{username},#{nickname},#{phone},#{gender});
		
		<selectKey keyProperty="userId" order="AFTER" resultType="Long">
					select last_insert_id() from dual;
		</selectKey>
	</insert>
	<insert id="createUserDetails" parameterType="Long">
		insert into user_role(user_id)
		values (#{userId});
		insert into user_info(user_id)
		values (#{userId});
	</insert>
	<select id="getUser" parameterType="Long" resultMap="UserMap">
		select 
			user.user_id, username, password, email, nickname, birthdate, phone, reg_date, update_date, gender, biz_id, expert_id, info.exp, info.status, info.count, info.start_date, role.authority
		from 
			user as user
		join 
			user_role as role
		on 
			role.user_id = user.user_id
        join 
			user_info as info
        on 
        	info.user_id = user.user_id
		where
			user.user_id = #{userId}
	</select>
	<select id="checkDuplicatedEmail" parameterType="String" resultType="Integer">
	      SELECT COUNT(*) FROM user WHERE email=#{email} 
	</select>
	
	<select id="checkDuplicatedNickname" parameterType="String" resultType="Integer">
	      SELECT COUNT(*) FROM user WHERE nickname=#{nickname}
	</select>
	
</mapper>